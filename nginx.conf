# 构建阶段
FROM oven/bun:latest as build

# 设置工作目录
WORKDIR /app

# 安装 git (用于处理可能的 git 依赖)
RUN apt-get update && apt-get install -y git

# 复制 package.json
COPY ./package.json ./

# 安装依赖
RUN bun install

# 复制所有源文件
COPY . .

# 创建 next.config.js 以忽略构建错误
RUN echo 'module.exports = { eslint: { ignoreDuringBuilds: true }, typescript: { ignoreBuildErrors: true }, output: "export" }' > next.config.js

# 构建静态文件
RUN bun run build

# 生产阶段
FROM nginx:alpine

# 从构建阶段复制静态文件到 Nginx 服务目录
COPY --from=build /app/out /usr/share/nginx/html

# 添加简单的 Nginx 配置
RUN echo 'server { listen 80; location / { root /usr/share/nginx/html; index index.html; try_files $uri $uri/ /index.html; } }' > /etc/nginx/conf.d/default.conf

# 暴露 80 端口
EXPOSE 80

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]